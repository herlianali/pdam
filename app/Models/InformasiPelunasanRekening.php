<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\DB;

class InformasiPelunasanRekening extends Model
{
    use HasFactory;

    public static function getInfo($periode, $periode1, $no_plg)
    {
        return DB::select("SELECT   a.* FROM (SELECT DECODE (x.status_lunas, 'L', 'LUNAS', 'BELUM') AS status,x.tgl_lunas, x.periode,  x.kd_tarif,'N' AS jenis, rp_air + rp_materai + rp_retribusi AS rp_rekening,NVL (rest_air, 0)+ NVL (rest_materai, 0)+ NVL (rest_retribusi, 0) AS rp_restitusi,NVL (rest_air, 0) + NVL (rest_materai, 0) AS rest_rekening,NVL (rest_retribusi, 0) AS rest_retribusi,CASE WHEN NVL(rest_air, 0)+ NVL (rest_materai, 0)+ NVL (rest_retribusi, 0) > 0 OR x.no_krmloket IS NULL THEN 0 Else getrpdendatgk (rp_air) END AS rp_denda, rp_air + rp_materai + rp_retribusi - NVL (rest_air, 0) - NVL (rest_materai, 0)  - NVL (rest_retribusi, 0) + CASE WHEN NVL(rest_air, 0) + NVL (rest_materai, 0) + NVL (rest_retribusi, 0) > 0 OR x.no_krmloket IS NULL THEN 0 Else getrpdendatgk (rp_air) END As rp_bayar FROM (SELECT status_lunas, tgl_lunas, SUBSTR (periode, 1, 2)|| '-'|| SUBSTR (periode, 3, 4) AS periode,rp_air , rp_materai, rp_retribusi, no_krmloket, kd_tarif From rs_tagih WHERE no_plg = '" .$no_plg. "' AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00'))Between '" .$periode. "' AND '" .$periode1. "'AND SUBSTR (periode, 3, 4) >= '2004'AND (   flag_akanbayar IS NULL OR flag_akanbayar = 'T' OR flag_akanbayar = 'B')) x,(SELECT    TRIM (TO_CHAR (bulan, '00'))|| '-' || TO_CHAR (tahun) AS periode,(rp_selpakai + rp_selsewamtr) AS rest_air, rp_selmaterai AS rest_materai,rp_selretribusi As rest_retribusi From rsp_tagih WHERE no_plg = '" .$no_plg. "' AND jns_perbaikanrek = 'R' AND tgl_batal IS NULL AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00')) Between '" .$periode. "' AND '" .$periode1. "' AND TO_CHAR (tgl_prosesrek, 'yyyy') >= '2004' AND (   flag_akanbayar IS NULL OR flag_akanbayar = 'T' OR flag_akanbayar = 'B')) y WHERE x.periode = y.periode(+) Union All SELECT DECODE (status_lunas, 'L', 'LUNAS', 'BELUM') AS status, tgl_lunas, TRIM (TO_CHAR (bulan, '00')) || '-' || TO_CHAR (tahun) AS periode, kd_tarif,jns_perbaikanrek AS jenis,(rp_selpakai + rp_selsewamtr + rp_selmaterai + rp_selretribusi ) AS rp_rekening,0 asrp_restitusi, 0 AS rest_rekening, 0 AS rest_retribusi,0 AS rp_denda,rp_selpakai+ rp_selsewamtr+ rp_selmaterai+ rp_selretribusi AS rp_bayar From rsp_tagih WHERE no_plg = '" .$no_plg. "' AND jns_perbaikanrek = 'S' AND tgl_batal IS NULL AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00')) Between '" .$periode. "' AND '" .$periode1. "' AND TO_CHAR (tgl_prosesrek, 'yyyy') >= '2004' AND (   flag_akanbayar IS NULL OR flag_akanbayar = 'T'OR flag_akanbayar = 'B') Union All SELECT DECODE (x.status, 'L', 'LUNAS', 'BELUM') AS status,x.tgl_lunas, x.periode, x.kd_tarif,'N' AS jenis, rp_rekening,NVL (y.rest_air, 0)+ NVL (y.rest_materai, 0)+ NVL (y.rest_retribusi, 0) AS rp_restitusi,NVL (y.rest_air, 0)+ NVL (y.rest_materai, 0) AS rest_rekening,NVL (y.rest_retribusi, 0) AS rest_retribusi,NVL (x.rp_denda, 0) rp_denda,rp_rekening- (  NVL (y.rest_air, 0)+ NVL (y.rest_materai, 0)+ NVL (y.rest_retribusi, 0))+ NVL (x.rp_denda, 0) AS rp_bayar FROM (SELECT status_lunas AS status, tgl_lunas,TRIM (TO_CHAR (bulan, '00')) || '-' || TO_CHAR (tahun) AS periode,'N' AS jenis,(rp_pakai + rp_sewameter + rp_materai + rp_retribusi+ppn1) AS rp_rekening,0 AS rp_restitusi, 0 AS rest_rekening, 0 AS rest_retribusi,rp_denda,rp_pakai+ rp_sewameter+ rp_materai+ rp_retribusi+ppn1 AS rp_bayar,kd_tarif FROM rp_tagih s WHERE no_plg = '" .$no_plg. "' AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00'))Between '" .$periode. "' AND '" .$periode1. "') x,(SELECT    TRIM (TO_CHAR (bulan, '00')) || '-' || TO_CHAR (tahun) AS periode,(rp_selpakai + rp_selsewamtr) AS rest_air,rp_selmaterai AS rest_materai,rp_selretribusi As rest_retribusi From rpp_tagih WHERE no_plg = '" .$no_plg. "' AND jns_perbaikanrek = 'R' AND tgl_batal IS NULL AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00')) Between '" .$periode. "' AND '" .$periode1. "'AND TO_CHAR (tgl_prosesrek, 'yyyy') >= '2004' AND (   flag_akanbayar IS NULL OR flag_akanbayar = 'T' OR flag_akanbayar = 'B')) y WHERE x.periode = y.periode(+) Union All SELECT DECODE (status_lunas, 'L', 'LUNAS', 'BELUM') AS status,tgl_lunas,TRIM (TO_CHAR (bulan, '00')) || '-' || TO_CHAR (tahun) AS periode,kd_tarif,jns_perbaikanrek AS jenis,(rp_selpakai + rp_selsewamtr + rp_selmaterai + rp_selretribusi ) AS rp_rekening,0 asrp_restitusi, 0 AS rest_rekening, 0 AS rest_retribusi,0 AS rp_denda,rp_selpakai + rp_selsewamtr + rp_selmaterai + rp_selretribusi AS rp_bayar From rpp_tagih WHERE no_plg = '" .$no_plg. "' AND jns_perbaikanrek = 'S' AND tgl_batal IS NULL AND TO_CHAR (tahun) || TRIM (TO_CHAR (bulan, '00')) Between '" .$periode. "' AND '" .$periode1. "' AND TO_CHAR (tgl_prosesrek, 'yyyy') >= '2004' AND (   flag_akanbayar IS NULL OR flag_akanbayar = 'T' OR flag_akanbayar = 'B')) a ORDER BY SUBSTR (periode, 4, 4) || SUBSTR (periode, 1, 2)");
    }

    public static function getNoPlg($no_plg)
    {
        return DB::select("SELECT B.TGL_OPERASI,A.*,TRIM(C.HASIL_OPERASI)||' - '||trim(C.KETERANGAN) AS KONDISI,D.PERIODE FROM DIL A,(SELECT NO_PLG,MAX(TGL_OPERASI) AS TGL_OPERASI FROM OPERASI_PENAGIHAN B, DOPERASI_PENAGIHAN C WHERE B.NO_OPERASI=C.NO_OPERASI AND C.BATAL=0 AND HASIL_OPERASI IS NULL AND NO_PLG='" .$no_plg. "' GROUP BY NO_PLG ) B, HASIL_OPERASI C,ZONA_PERIODE D WHERE A.NO_PLG=B.NO_PLG (+) AND A.HASIL_OPERASI=C.HASIL_OPERASI(+) AND A.NO_PLG='" .$no_plg. "' AND A.ZONA=D.ZONA");
    }
}
